# S3Upload Plugin for Typecho

一款支持 S3 兼容协议的文件上传插件，
支持自定义域名、文件压缩 等功能。

## 兼容性

- **Typecho 1.3.0+**: 完全兼容
- **PHP 7.4+**: 推荐使用
- **必需扩展**: cURL, GD (图片压缩功能)

## 文件结构

1. **Plugin.php**
   - 插件主文件
   - 包含插件定义、配置和钩子
   - 负责插件的安装、激活和配置

2. **S3Client.php**
   - S3 协议客户端实现
   - 处理与 S3 服务器的通信
   - 实现文件上传、删除等基本操作

3. **StreamUploader.php**
   - 文件上传处理类
   - 处理文件分块上传
   - 管理上传过程和临时文件

4. **FileHandler.php**
   - 文件处理主类
   - 处理 Typecho 的文件上传钩子
   - 管理文件的上传、修改和删除

5. **Utils.php**
   - 工具类
   - 提供日志记录功能
   - 提供文件类型判断等辅助功能

## 功能特性

- 支持标准 S3 协议
- 支持自定义域名和 CDN
- 支持 HTTPS
- 支持文件本地备份
- 支持自定义存储路径
- 支持虚拟主机和路径两种访问方式
- 支持图片自动压缩 (需要GD库)

## 安装方法

1. 下载插件并解压到 `usr/plugins/S3Upload` 目录
2. 在 Typecho 后台启用插件
3. 配置 S3 相关参数

## 配置说明

- **Endpoint**: S3 服务器地址
- **Bucket**: 存储桶名称
- **Region**: 区域
- **Access Key**: 访问密钥 ID
- **Secret Key**: 访问密钥密码
- **自定义域名**: CDN 或自定义域名
- **HTTPS**: 是否使用 HTTPS
- **URL 风格**: 路径或虚拟主机方式
- **自定义路径**: 存储路径前缀
- **本地备份**: 是否保留本地副本
- **图片压缩**: 是否对上传的图片进行自动压缩
- **压缩质量**: 图片压缩质量 (1-100)

## 同步功能

插件提供了本地文件同步到S3的功能，可以将之前上传的本地文件批量上传到S3存储。

### 使用方法

1. 在Typecho后台进入插件设置页面
2. 配置完整的S3参数（Endpoint、Bucket、Access Key、Secret Key）
3. 点击"打开同步管理"按钮进入同步管理面板
4. 在同步管理面板中查看本地文件统计信息
5. 点击"开始同步"按钮开始同步过程
6. 同步过程中可以查看实时进度和日志

### 同步说明

- 同步工具会扫描 `/usr/uploads/` 目录下的所有文件
- 支持递归扫描子目录
- 自动跳过隐藏文件和临时文件
- 显示同步进度和错误日志
- 支持重复同步（已存在的文件会被跳过）
- 独立的同步管理面板，提供更好的用户体验
- 在开始同步前会自动检查S3配置是否完整

## 注意事项

1. 确保 PHP 已安装 curl 扩展
2. 确保 PHP 已安装 GD 库 (如需使用图片压缩功能)
3. 确保目录有写入权限
4. 建议开启 PHP 错误日志
5. 建议定期检查日志文件

## 故障排除

如果同步功能无法正常工作，请检查以下内容：

1. **检查浏览器控制台**: 打开浏览器开发者工具，查看Console标签页中的错误信息
2. **检查PHP错误日志**: 查看服务器错误日志，插件会输出调试信息
3. **检查插件配置**: 确保S3配置完整且正确
4. **检查文件权限**: 确保 `/usr/uploads/` 目录可读
5. **检查网络连接**: 确保服务器能够访问S3服务

### 调试信息

插件会在PHP错误日志中输出调试信息，格式为：
- `S3Upload: handleAjaxRequests called` - AJAX请求处理开始
- `S3Upload: Processing stats request` - 统计请求处理
- `S3Upload: getSyncStats called` - 统计方法调用
- `S3Upload: stats = {...}` - 统计结果

## 版本历史

- 1.3.0:
  - 修复 Typecho 1.3.0 兼容性问题
  - 更新命名空间和类引用
  - 优化文件处理机制

- 1.2.0:
  - 增加了图片压缩的功能,开启压缩功能时,会排除100KB以下的图片压缩.
  - 增加了压缩质量的配置项,默认值为85,可根据需要自行调整.自动转为webp格式.

- 1.1.0:
  - 上传本地备份路径不正确的问题 (现按照原始路径保存)

- 1.0.0: 初始版本
  - 基本的 S3 上传功能
  - 支持自定义域名
  - 支持 CDN 配置

## Typecho 1.3.0 兼容性修复说明

### 主要问题
1. **命名空间变化**: Typecho 1.3.0 对命名空间进行了重构
2. **类引用方式**: 部分类的引用方式发生了变化
3. **文件处理机制**: 文件上传处理机制有所调整
4. **配置面板**: 配置面板的实现方式需要更新

### 修复内容
1. **Plugin.php**:
   - 更新了命名空间引用
   - 修复了插件接口实现
   - 更新了版本依赖声明

2. **FileHandler.php**:
   - 修复了Options类的引用方式
   - 更新了文件类型检查机制
   - 优化了文件处理逻辑

3. **StreamUploader.php**:
   - 修复了Helper类的引用
   - 更新了配置获取方式

4. **README.md**:
   - 添加了兼容性说明
   - 更新了版本历史
   - 增加了详细的修复说明

### 技术栈
- **PHP**: 7.4+
- **Typecho**: 1.3.0+
- **扩展**: cURL, GD
- **协议**: S3 兼容协议

### 修改的文件
1. `Plugin.php` - 主插件文件，修复命名空间和接口，添加同步功能
2. `FileHandler.php` - 文件处理类，更新类引用和逻辑
3. `StreamUploader.php` - 上传处理类，修复配置获取
4. `S3Sync.php` - 新增同步处理类，实现本地文件同步功能
5. `SyncHandler.php` - 新增同步处理页面，提供Web界面
6. `sync.php` - 新增同步工具入口文件
7. `README.md` - 文档更新，添加兼容性说明和同步功能说明

## 作者

- @jkjoy + Claude Code

## 许可证

MIT License